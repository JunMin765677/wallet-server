// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// 1. 定義 Prisma 客戶端生成器 (for Express/Node.js)
generator client {
  provider = "prisma-client-js"
}

// 2. 定義資料庫連線 (請將 "postgresql" 換成您的資料庫，例如 mysql 或 sqlite)
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------
// 核心表 (Tables)
// -------------------------------------------------

/// 1. VCTemplates - VC 模板表
model VCTemplate {
  id              Int                 @id @default(autoincrement())
  templateName    String              @db.VarChar(100)
  vcUid           String?             @db.VarChar(255)
  description     String?             @db.Text
  cardImageUrl    String?             @db.VarChar(255)
  createdAt       DateTime            @default(now())
  
  // 關聯
  eligibilities   PersonEligibility[] // (1-M) 關聯至 PersonEligibilities
  issuedVCs       IssuedVC[]          // (1-M) 關聯至 IssuedVCs
}

/// 2. Persons - 使用者資料總表
model Person {
  id                      BigInt              @id @default(autoincrement())
  personalId              String              @unique @db.VarChar(255) // 建立索引 (unique)
  
  // [⭐️ 變更 ⭐️] nationalId (移除 hash) (設為 ? 可選，解決 migrate 錯誤)
  nationalId              String?             @db.VarChar(255) 
  
  name                    String              @db.VarChar(255)
  county                  String?             @db.VarChar(50)
  district                String?             @db.VarChar(50)
  address                 String?             @db.VarChar(500)
  phoneNumber             String?             @db.VarChar(20)
  dateOfBirth             DateTime?           @db.Date
  
  // 新增緊急聯絡人相關欄位
  emergencyContactName        String?             @db.VarChar(255) // 緊急聯絡人
  emergencyContactRelationship String?            @db.VarChar(100) // 緊急聯絡人親屬關係
  emergencyContactPhone   String?             @db.VarChar(20)    // (此欄位本來就存在)

  // 新增審核相關欄位
  reviewingAuthority          String?             @db.VarChar(255) // 審核機關
  reviewerName                String?             @db.VarChar(255) // 審核人員
  reviewerPhone               String?             @db.VarChar(50)  // 審核人員電話

  // 新增資格效期
  eligibilityStartDate        DateTime?           @db.Date // 資格的有效期限起始日
  eligibilityEndDate          DateTime?           @db.Date // 資格的有效期限到期日

  // 新增福利資格與財產欄位 (使用 BigInt 容納大數值，並設為 nullable)
  // [⭐️ 變更 ⭐️] 移除 benefitLevel
  personalAnnualIncome        BigInt?             // 個人年所得
  personalMovableAssets       BigInt?             // 個人動產總額
  personalRealEstateAssets    BigInt?             // 個人不動產總額
  familyAnnualIncome          BigInt?             // 家庭成員年所得
  familyMovableAssets         BigInt?             // 家庭成員動產總額
  familyRealEstateAssets      BigInt?             // 家庭成員不動產總額
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  
  // 關聯
  eligibilities           PersonEligibility[] // (1-M) 關聯至 PersonEligibilities
  issuedVCs               IssuedVC[]          // (1-M) 關聯至 IssuedVCs
  verificationLogs        VerificationLog[]   // (1-M) 關聯至 VerificationLog
}

/// 3. PersonEligibilities - 模擬使用者資格表 (M2M 關聯表)
model PersonEligibility {
  id          BigInt      @id @default(autoincrement())
  
  // 關聯欄位
  personId    BigInt
  templateId  Int
  
  // 關聯定義
  person      Person      @relation(fields: [personId], references: [id])
  template    VCTemplate  @relation(fields: [templateId], references: [id])
  
  createdAt   DateTime    @default(now())

  // 確保同一個使用者對同一個模板只有一筆資格紀錄
  @@unique([personId, templateId])
}

/// 4. IssuedVCs - 已簽發 VC 紀錄表
model IssuedVC {
  id          BigInt        @id @default(autoincrement())
  systemUuid  String        @unique @db.VarChar(255) // 我們系統的 UUID，用於驗證追蹤
  cid         String?       @db.VarChar(255)         // Sandbox 提供的 VC 唯一 ID (來自 JTI)
  issuedData  Json          // 簽發時存入卡面的資料
  
  // [⭐️ 變更 ⭐️] 新增福利資格等級 (文字)
  benefitLevel String?      @db.VarChar(100)
  
  status      IssuanceStatus // 使用 Enum (見下方定義)
  issuedAt    DateTime?     // 實際簽發日期
  expiredAt   DateTime?     // 過期日期
  createdAt   DateTime      @default(now())
  
  // 關聯欄位
  personId    BigInt
  templateId  Int
  
  // 關聯定義
  person      Person        @relation(fields: [personId], references: [id])
  template    VCTemplate    @relation(fields: [templateId], references: [id])
  
  // 關聯 (1-M)
  issuanceLogs      IssuanceLog[]
}

/// 5. IssuanceLogs - 簽發日誌表
model IssuanceLog {
  id            BigInt            @id @default(autoincrement())
  transactionId String            @unique @db.VarChar(255) // 簽發流程的暫時性 ID
  status        IssuanceLogStatus // 使用 Enum (見下方定義)
  expiresAt     DateTime?         // 流程超時時間
  createdAt     DateTime          @default(now())
  
  // 關聯欄位
  issuedVcId    BigInt
  
  // 關聯定義
  issuedVC      IssuedVC          @relation(fields: [issuedVcId], references: [id])
}

// [⭐️ 新增 ⭐️]
/// 6. BatchVerificationSessions - 批次驗證工作階段表
model BatchVerificationSession {
  id                  BigInt            @id @default(autoincrement())
  uuid                String            @unique @default(uuid()) @db.VarChar(255) // 供 QR Code 使用的 UUID
  
  // 驗證中繼資料 (由驗證方在建立工作階段時提供)
  verifierInfo        String?           @db.VarChar(255) // (例如: 醫院)
  verifierBranch      String?           @db.VarChar(255) // (例如: 林口長壽醫院)
  verificationReason  String?           @db.VarChar(255)
  notes               String?           @db.VarChar(500)
  
  status              BatchVerificationStatus // 使用 Enum (見下方定義)
  
  expiresAt           DateTime?         // 批次工作階段的超時時間
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  // 關聯 (1-M)
  verificationLogs    VerificationLog[]
}

/// 7. VerificationLogs - 驗證紀錄表 (原為 6)
model VerificationLog {
  id                  BigInt                @id @default(autoincrement())
  transactionId       String                @unique @db.VarChar(255) // 驗證流程的暫時性 ID
  verifyResult        Boolean?              // 驗證結果 (true/false)
  resultDescription   String?               @db.VarChar(255)
  returnedData        Json?                 // 驗證方收到的 claims 資料
  
  verifierInfo        String?               @db.VarChar(255) // (例如: 醫院)
  
  // 新增 verifierBranch (例如: 林口長庚醫院)
  verifierBranch      String?               @db.VarChar(255)
  
  verificationReason  String?               @db.VarChar(255)
  notes               String?               @db.VarChar(500)
  status              VerificationStatus    // 使用 Enum (見下方定義)
  expiresAt           DateTime?             // 流程超時時間
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  // 關聯欄位 (Nullable FK)，改為關聯至 Person
  verifiedPersonId    BigInt?               
  
  // [⭐️ 新增 ⭐️] 關聯欄位 (Nullable FK)，用於批次驗證
  batchVerificationSessionId BigInt?

  // 關聯定義
  verifiedPerson      Person?               @relation(fields: [verifiedPersonId], references: [id])
  
  // [⭐️ 新增 ⭐️] 關聯定義
  batchVerificationSession BatchVerificationSession? @relation(fields: [batchVerificationSessionId], references: [id])

  // [⭐️ 新增 ⭐️] 為 FK 建立索引
  @@index([batchVerificationSessionId])
}


// -------------------------------------------------
// 列舉類型 (Enums) - 提升資料一致性
// -------------------------------------------------

/// IssuedVCs.status 的可能值
enum IssuanceStatus {
  issuing
  issued
  expired
  revoked
}

/// IssuanceLogs.status 的可能值
enum IssuanceLogStatus {
  initiated
  user_claimed
  expired
}

/// VerificationLogs.status 的可能值
enum VerificationStatus {
  initiated
  success
  failed
  expired
  error_missing_uuid // (這個 Enum 值被重用於 "找不到 personalId" 或 "DB 中查無此人")
}

// [⭐️ 新增 ⭐️]
/// BatchVerificationSessions.status 的可能值
enum BatchVerificationStatus {
  active   // 工作階段進行中
  closed   // 已由驗證方手動關閉
  expired  // 工作階段已自動過期
}